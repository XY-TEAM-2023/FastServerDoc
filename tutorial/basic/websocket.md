# websocket

### 定义API接口

通过 FS_注册WS接口 定义接口

```c
FS_注册WS接口 ("/test", WS接口校验)
```

!> WS 和 HTTP 可以注册相同的API地址



---

### 取请求参数

使用方法和HTTP接口完全一致

- 客户端请求

  ```json
  {
      // 请求的API，不持支URL参数，不支持RESTFul
      "uri": "/test",
      
      // 可空。请求提交的数据，必须是JSON对象，不能是数组
      "data": {
          "string": "Hello, World!",
          "number": 42,
          "boolean": true,
          "null": null,
          "array": [
              1,
              2,
              3
          ],
          "object": {
              "key": "value"
          },
          "float": 3.14
      }
  }
  ```

- 服务器取参数

  ![image-20240905114838590](./C:/Users/Admin/Downloads/websocket.assets/image-20240905114838590.png)

  ```c
  <火山程序 类型 = "通常" 版本 = 1 />
  
  方法 WS接口校验 <公开 静态 类型 = 逻辑型 返回值注释 = "返回值无意义" 折叠>
  参数 请求 <类型 = FastServer_WS请求解析类Ex>
  参数 响应 <类型 = FastServer_WS响应处理类Ex>
  参数 数据库 <类型 = Mysql连接类Ex>
  参数 用户缓存 <类型 = FastServer_用户缓存类Ex>
  参数 全局缓存 <类型 = FastServer_全局缓存类Ex>
  {
      变量 参数检查结果 <类型 = E_参数检查结果 值 = E_参数检查结果.成功>
      变量 模拟提交参数 <类型 = 文本型
              值 = "{\r\n  \"string\": \"Hello, World!\",\r\n  \"number\": 42,\r\n  \"boolean\": true,\r\n  \"null\": null,\r\n  \"array\": [1, 2, 3],\r\n  \"object\": {\r\n    \"key\": \"value\"\r\n  },\r\n  \"float\": 3.14\r\n}">
      变量 数据检查 <类型 = JSON对象类Ex>
      数据检查.创建自文本 (模拟提交参数)
      变量 参_全部 <类型 = JSON对象类Ex>
      请求.取参数_全部 (参_全部)
      响应.数据.置入文本值 ("检查-整体数据", 选择 (参_全部.到可读文本 (, ) == 数据检查.到可读文本 (, ), "√", "×"))
      响应.数据.置入文本值 ("检查-string", 选择 (请求.取参数_文本 ("string", , , , , 参数检查结果) == 数据检查.取文本值 ("string"), "√", "×"))
      响应.数据.置入文本值 ("检查-number", 选择 (请求.取参数_整数 ("number", , , , , 参数检查结果) == 数据检查.取整数值 ("number"), "√", "×"))
      响应.数据.置入文本值 ("检查-boolean", 选择 (请求.取参数_逻辑值 ("boolean", , 参数检查结果) == 数据检查.取逻辑值 ("boolean"), "√", "×"))
      响应.数据.置入文本值 ("检查-null", 选择 (请求.取参数_文本 ("null", , , , , 参数检查结果) == 数据检查.取文本值 ("null"), "√", "×"))
      变量 数组1 <类型 = JSON数组类Ex>
      变量 数组2 <类型 = JSON数组类Ex>
      请求.取参数_JSON数组 ("array", , , , 参数检查结果, 数组1)
      数据检查.取数组值 ("array", 数组2)
      响应.数据.置入文本值 ("检查-array", 选择 (数组1.到可读文本 () == 数组2.到可读文本 (), "√", "×"))
      变量 obj1 <类型 = JSON对象类Ex>
      变量 obj2 <类型 = JSON对象类Ex>
      请求.取参数_JSON对象 ("object", , 参数检查结果, obj1)
      数据检查.取对象值 ("object", obj2)
      响应.数据.置入文本值 ("检查-array", 选择 (obj1.到可读文本 (, ) == obj2.到可读文本 (, ), "√", "×"))
      响应.数据.置入文本值 ("检查-float", 选择 (请求.取参数_小数 ("float", , , , , 参数检查结果) == 数据检查.取小数值 ("float"), "√", "×"))
      返回 (响应.发送 (__FS_E_状态码.__未定义, "测试结果"))
  }
  ```

- 运行结果

  ```json
  {
      "status": -99999,
      "msg": "测试结果",
      "data": {
          "检查-整体数据": "√",
          "检查-string": "√",
          "检查-number": "√",
          "检查-boolean": "√",
          "检查-null": "√",
          "检查-array": "√",
          "检查-float": "√"
      }
  }
  ```



---

### 响应

使用方法HTTP接口完全一致

- 设置响应数据

  ```
  响应.数据.置入xxx
  ```

- 发送消息函数

  ```c
  响应.发送 (__FS_E_状态码.__未定义, "测试结果")
  响应.发送2 (0, "测试结果")
  ```

- 响应数据结构

  ```json
  {
  	"status": 0, // 响应状态码
      "data": {}, // 响应数据
      "msg": '' // 响应描述
  }
  ```

- 发送自定义数据

  ```c
  响应.发送自定义数据()
  ```

---

### 内置状态码

!> 当服务器内部异常时，会返回以下状态码，比如

```
{
	"status": 404,
    "msg": '未定义的请求'
}
```

| 状态码 | 状态码描述                             |
| ------ | -------------------------------------- |
| -404   | 未定义的请求                           |
| -501   | 服务器内部错误。取Redis全局缓存失败    |
| -502   | 服务器内部错误。非法数据（无效的JSON） |
| -503   | 服务器内部错误。取Redis用户缓存失败    |
| -504   | 服务器内部错误。取数据库连接失败       |



---

### 用户缓存

使用方法和HTTP一致。用户缓存仅在用户保持连接的状态下有效

- 设置用户缓存

  ![image-20240905122129620](./C:/Users/Admin/Downloads/websocket.assets/image-20240905122129620.png)

  ```c
  <火山程序 类型 = "通常" 版本 = 1 />
  
  变量 缓存时长ms <类型 = 整数 值 = 5000>
  用户缓存.置入文本值 ("string", "文本型数据", 缓存时长ms)
  用户缓存.置入字节集 ("zjj", 文本到UTF8 ("字节集数据", 假), 缓存时长ms)
  用户缓存.置入小数值 ("float", 3.14, 缓存时长ms)
  用户缓存.置入整数值 ("int", 1111, 缓存时长ms)
  用户缓存.置入逻辑值 ("bool", 真, 缓存时长ms)
  
  变量 文本数组 <类型 = 文本数组类>
  文本数组.加入成员 ("1")
  文本数组.加入成员 ("a")
  文本数组.加入成员 ("嘿")
  用户缓存.置入文本数组 ("str_arr", 文本数组, 缓存时长ms)
  用户缓存.置入短整数值 ("short", 122, 缓存时长ms)
  用户缓存.置入长整数值 ("long", 123123123, 缓存时长ms)
  
  变量 cache_obj <类型 = JSON对象类Ex>
  cache_obj.置入文本值 ("a", "aaaa")
  cache_obj.置入逻辑值 ("bool", 真)
  用户缓存.置入JSON对象值 ("obj", cache_obj, 缓存时长ms)
  
  变量 cache_arr <类型 = JSON数组类Ex>
  cache_arr.置入文本值 ("aaaaaaaaa", )
  cache_arr.置入小数值 (111.11, )
  cache_arr.置入整数值 (34333, )
  用户缓存.置入JSON数组值 ("arr", cache_arr, 缓存时长ms)
  ```

- 读取用户缓存

  ![image-20240905122113614](./C:/Users/Admin/Downloads/websocket.assets/image-20240905122113614.png)

  ```c
  <火山程序 类型 = "通常" 版本 = 1 />
  
  变量 文本数组2 <类型 = 文本数组类>
  响应.数据.置入文本值 ("//用户缓存.string", 用户缓存.取文本值 ("string"))
  响应.数据.置入文本值 ("//用户缓存.zjj", UTF8到文本 (用户缓存.取字节集 ("zjj")))
  响应.数据.置入小数值 ("//用户缓存.float", 用户缓存.取小数值 ("float"))
  响应.数据.置入整数值 ("//用户缓存.int", 用户缓存.取整数值 ("int"))
  响应.数据.置入逻辑值 ("//用户缓存.bool", 用户缓存.取逻辑值 ("bool"))
  用户缓存.取文本数组 ("str_arr", 文本数组2)
  响应.数据.置入文本数组 ("//用户缓存.str_arr", 文本数组2)
  
  变量 cache_obj2 <类型 = JSON对象类Ex>
  用户缓存.取JSON对象值 ("obj", cache_obj2)
  响应.数据.置入对象值 ("//用户缓存.obj", cache_obj2)
  
  变量 cache_arr2 <类型 = JSON数组类Ex>
  用户缓存.取JSON数组值 ("arr", cache_arr2)
  响应.数据.置入数组值 ("//用户缓存.arr", cache_arr2)
  ```



---

### 全局缓存

与HTTP使用方法完全一致



---

### 其余全局函数

连接ID可以通过 WS处理函数中 `请求.取连接ID()` 得到

| 函数名                 |
| ---------------------- |
| FS\_推送WS消息\_文本   |
| FS\_推送WS消息\_字节集 |
| FS\_取所有WS连接       |
| FS\_断开WS连接\_指定   |
| FS\_断开WS连接\_所有   |

